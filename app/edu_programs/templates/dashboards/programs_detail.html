{% extends 'base.html' %}
{% load static i18n %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <h1 class="text-center">{% trans "Детальная информация по образовательным программам" %}</h1>

    <!-- Filters -->
    <form method="GET" class="filter-form">
        <div class="filter-group">
            <label for="program_code">{% trans "Направление подготовки" %}:</label>
            <select name="program_code" id="program_code">
                <option value="">{% trans "Все" %}</option>
                {% for program in program_codes %}
                    <option value="{{ program.code }}" {% if program_code == program.code %}selected{% endif %}>
                        {{ program.code }} - {{ program.name }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-buttons">
            <button type="submit" class="btn btn-primary">{% trans "Применить фильтр" %}</button>
            <a href="{% url 'programs_detail' %}" class="btn btn-secondary">{% trans "Сбросить фильтр" %}</a>
        </div>
    </form>

    <!-- Pie Chart -->
    <div class="chart-container">
        <canvas id="profilesChart"></canvas>
    </div>

    <!-- Profiles List -->
    <h2 class="text-center">{% trans "Профили направления" %}</h2>
    <table class="programs-table">
        <thead>
            <tr>
                <th>{% trans "Профиль" %}</th>
                <th>{% trans "Квалификация" %}</th>
                <th>{% trans "Факультет" %}</th>
                <th>{% trans "Действия" %}</th>
            </tr>
        </thead>
        <tbody>
            {% for program in programs %}
                <tr>
                    <td>{{ program.profile|default:"—" }}</td>
                    <td>{{ program.qualification|default:"—" }}</td>
                    <td>{{ program.faculty.abbreviation }}</td>
                    <td>
                        <button class="btn btn-info show-standards" data-program-id="{{ program.id }}">{% trans "Показать проф. стандарты" %}</button>
                        <button class="btn btn-info show-details" data-program-id="{{ program.id }}">{% trans "Подробности" %}</button>
                        <a href="{% url 'program_detail_report' program.id %}?program_code={{ program_code|urlencode }}" class="btn btn-success">{% trans "Скачать отчёт" %}</a>
                    </td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="4">{% trans "Нет данных для отображения" %}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Professional Standards -->
    <div id="standards-section" style="display: none;">
        <h2 class="text-center">{% trans "Профессиональные стандарты" %}</h2>
        <table class="programs-table" id="standards-table">
            <thead>
                <tr>
                    <th>{% trans "Код" %}</th>
                    <th>{% trans "Название" %}</th>
                    <th>{% trans "Сфера деятельности" %}</th>
                </tr>
            </thead>
            {% for program in programs %}
                <tbody class="standards-data" data-program-id="{{ program.id }}" style="display: none;">
                    {% for standard in program.professional_standards.all %}
                        <tr>
                            <td>{{ standard.code }}</td>
                            <td>{{ standard.title }}</td>
                            <td>{{ standard.domain }}</td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="3">{% trans "Нет данных" %}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            {% endfor %}
        </table>
    </div>

    <!-- Program Details -->
    <div id="details-section" style="display: none;">
        <h2 class="text-center">{% trans "Подробная информация о программе" %}</h2>
        <table class="programs-table" id="details-table">
            <tbody id="details-body">
                {% for program in programs %}
                    <tr class="details-data" data-program-id="{{ program.id }}" style="display: none;">
                        <td><strong>{% trans "Код" %}</strong></td><td>{{ program.code|default:"—" }}</td>
                    </tr>
                    <tr class="details-data" data-program-id="{{ program.id }}" style="display: none;">
                        <td><strong>{% trans "Название" %}</strong></td><td>{{ program.name|default:"—" }}</td>
                    </tr>
                    <tr class="details-data" data-program-id="{{ program.id }}" style="display: none;">
                        <td><strong>{% trans "Профиль" %}</strong></td><td>{{ program.profile|default:"—" }}</td>
                    </tr>
                    <tr class="details-data" data-program-id="{{ program.id }}" style="display: none;">
                        <td><strong>{% trans "Квалификация" %}</strong></td><td>{{ program.qualification|default:"—" }}</td>
                    </tr>
                    <tr class="details-data" data-program-id="{{ program.id }}" style="display: none;">
                        <td><strong>{% trans "Университет" %}</strong></td><td>{{ program.university.abbreviation|default:"—" }}</td>
                    </tr>
                    <tr class="details-data" data-program-id="{{ program.id }}" style="display: none;">
                        <td><strong>{% trans "Факультет" %}</strong></td><td>{{ program.faculty.abbreviation|default:"—" }}</td>
                    </tr>
                    <tr class="details-data" data-program-id="{{ program.id }}" style="display: none;">
                        <td><strong>{% trans "Год утверждения" %}</strong></td><td>{{ program.approval_year|default:"—" }}</td>
                    </tr>
                    <tr class="details-data" data-program-id="{{ program.id }}" style="display: none;">
                        <td><strong>{% trans "Срок обучения" %}</strong></td><td>{{ program.duration_years|default:"—" }} {% trans "лет" %}</td>
                    </tr>
                    <tr class="details-data" data-program-id="{{ program.id }}" style="display: none;">
                        <td><strong>{% trans "Зачётные единицы" %}</strong></td><td>{{ program.total_credits|default:"—" }}</td>
                    </tr>
                    <tr class="details-data" data-program-id="{{ program.id }}" style="display: none;">
                        <td><strong>{% trans "Язык обучения" %}</strong></td><td>{{ program.language|default:"—" }}</td>
                    </tr>
                    <tr class="details-data" data-program-id="{{ program.id }}" style="display: none;">
                        <td><strong>{% trans "Контактные часы" %}</strong></td><td>{{ program.contact_hours_min|default:"—" }}</td>
                    </tr>
                    <tr class="details-data" data-program-id="{{ program.id }}" style="display: none;">
                        <td><strong>{% trans "Документ" %}</strong></td><td>{{ program.document|default:"—" }}</td>
                    </tr>
                    <tr class="details-data" data-program-id="{{ program.id }}" style="display: none;">
                        <td><strong>{% trans "Обработан" %}</strong></td><td>{{ program.is_processed|yesno:"Да,Нет" }}</td>
                    </tr>
                    <tr class="details-data" data-program-id="{{ program.id }}" style="display: none;">
                        <td><strong>{% trans "Ошибка обработки" %}</strong></td><td>{{ program.processing_error|default:"—" }}</td>
                    </tr>
                    <tr class="details-data" data-program-id="{{ program.id }}" style="display: none;">
                        <td><strong>{% trans "Профессиональные стандарты" %}</strong></td><td>
                            {% for standard in program.professional_standards.all %}
                                {{ standard.title }}{% if not forloop.last %}, {% endif %}
                            {% empty %}
                                —
                            {% endfor %}
                        </td>
                    </tr>
                    <tr class="details-data" data-program-id="{{ program.id }}" style="display: none;">
                        <td><strong>{% trans "Дисциплины" %}</strong></td><td>
                            {% for discipline in program.disciplines.all %}
                                {{ discipline.code }} - {{ discipline.name }}{% if not forloop.last %}<br> {% endif %}
                            {% empty %}
                                —
                            {% endfor %}
                        </td>
                    </tr>
                    <tr class="details-data" data-program-id="{{ program.id }}" style="display: none;">
                        <td><strong>{% trans "Компетенции" %}</strong></td><td>
                            {% for competency in program.competencies %}
                                {{ competency.competencies__code }}{% if not forloop.last %}; {% endif %}
                            {% empty %}
                                —
                            {% endfor %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="{% static 'js/programs_detail.js' %}"></script>
    <script>
        const chartData = {{ chart_data|safe }};
        console.log('Detail Chart Data:', chartData); // Debug
        initializeProfilesChart(chartData);
    </script>
{% endblock %}
