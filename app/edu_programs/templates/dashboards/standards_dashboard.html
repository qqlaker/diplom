{% extends 'base.html' %}
{% load static i18n %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <h1 class="text-center">{% trans "Профессиональные стандарты" %}</h1>

    <!-- Filters -->
    <form method="GET" class="filter-form">
        <div class="filter-group">
            <label for="faculties">{% trans "Факультеты" %}:</label>
            <select name="faculties" id="faculties" multiple>
                {% for faculty in faculties %}
                    <option value="{{ faculty.id }}" {% if faculty.id in selected_faculties %}selected{% endif %}>
                        {{ faculty.abbreviation }} - {{ faculty.name }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-group">
            <label for="qualification">{% trans "Квалификация" %}:</label>
            <select name="qualification" id="qualification">
                <option value="">{% trans "Все" %}</option>
                <option value="бакалавриат" {% if qualification == 'бакалавриат' %}selected{% endif %}>{% trans "Бакалавриат" %}</option>
                <option value="магистратура" {% if qualification == 'магистратура' %}selected{% endif %}>{% trans "Магистратура" %}</option>
                <option value="специалитет" {% if qualification == 'специалитет' %}selected{% endif %}>{% trans "Специалитет" %}</option>
            </select>
        </div>
        <div class="filter-buttons">
            <button type="submit" class="btn btn-primary">{% trans "Применить фильтры" %}</button>
            <a href="{% url 'standards_dashboard' %}" class="btn btn-secondary">{% trans "Сбросить фильтры" %}</a>
        </div>
    </form>


    <div class="chart-container">
        <canvas id="standardsByYearChart"></canvas>  <!-- Line Chart (Standards by Year) -->
        <canvas id="standardsByQualChart"></canvas>  <!-- Bar Chart (Standards by Qualification) -->
    </div>

    <!-- Standards Table -->
    <h2 class="text-center">{% trans "Детализация профессиональных стандартов" %}</h2>
    <table class="programs-table">
        <thead>
            <tr>
                <th>{% trans "Код" %}</th>
                <th>{% trans "Название" %}</th>
                <th>{% trans "Сфера деятельности" %}</th>
                <th>{% trans "Связанные программы" %}</th>
            </tr>
        </thead>
        <tbody>
            {% for standard in standards %}
                <tr>
                    <td>{{ standard.code|default:"—" }}</td>
                    <td>{{ standard.title|default:"—" }}</td>
                    <td>{{ standard.domain|default:"—" }}</td>
                    <td>
                        {% for program in standard.program_set.all %}
                            {{ program.code }} - {{ program.name }}{% if not forloop.last %}, {% endif %}
                        {% empty %}
                            —
                        {% endfor %}
                    </td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="4">{% trans "Нет данных для отображения" %}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block extra_js %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="{% static 'js/standards_dashboard.js' %}"></script>
    <script>
        const lineChartData = {{ line_chart_data|safe }};
        const barChartData = {{ bar_chart_data|safe }};
        console.log('Line Chart Data:', lineChartData); // Debug
        console.log('Bar Chart Data:', barChartData); // Debug
        initializeStandardsCharts(lineChartData, barChartData);
    </script>
{% endblock %}
